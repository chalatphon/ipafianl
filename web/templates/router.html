<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>Router {{ router_ip }}</title>
    <link rel="stylesheet" href="/static/style.css" />
</head>
<body class="page">
    <header class="header detail-header">
        <div>
            <h1>Router: {{ router_ip }}</h1>
            <p>สรุป Route Table และ Interface Status ล่าสุด</p>
        </div>
        <div class="action-buttons">
            <a href="/" class="btn-secondary">← กลับหน้าหลัก</a>
            <a href="{{ url_for('router_detail', ip=router_ip) }}" class="btn-secondary">Refresh</a>
        </div>
    </header>

    {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
    <section class="alert-stack">
        {% for category, message in messages %}
        <div class="alert alert-{{ category }}">{{ message }}</div>
        {% endfor %}
    </section>
    {% endif %}
    {% endwith %}

    <section class="card" id="table-container">
        <div class="card-split">
            <div class="card-block">
                <h2>Loopback Interfaces</h2>
                <form method="POST" action="{{ url_for('create_loopback_route', ip=router_ip) }}" class="loopback-form">
                    <label>
                        <span>Loopback ID</span>
                        <input name="loopback_id" placeholder="1 หรือ Loopback1" required />
                    </label>
                    <label>
                        <span>IP Address</span>
                        <input name="loopback_ip" placeholder="10.10.10.1" required />
                    </label>
                    <label>
                        <span>Netmask</span>
                        <input name="loopback_netmask" placeholder="255.255.255.255" required />
                    </label>
                    <label>
                        <span>Enable Secret (override)</span>
                        <input name="loopback_secret" type="password" placeholder="ใส่ถ้าไม่ตรงกับข้อมูลเดิม" />
                    </label>
                    <button type="submit" class="btn-primary">สร้าง Loopback</button>
                </form>

                {% if loopbacks %}
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Interface</th>
                            <th>IP</th>
                            <th>Netmask</th>
                            <th>Admin</th>
                            <th>Oper</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in loopbacks %}
                        {% set status = loopback_status.get(item.interface) %}
                        <tr>
                            <td>{{ item.interface }}</td>
                            <td>{{ item.ip or '-' }}</td>
                            <td>{{ item.netmask or '-' }}</td>
                            <td>{{ item.admin_state|default('unknown') }}</td>
                            <td>
                                {% if status %}
                                    {{ status.status }}/{{ status.proto }}
                                {% else %}
                                    -
                                {% endif %}
                            </td>
                           <td>
                                <div class="loopback-actions">
                                    <form action="{{ url_for('update_loopback_state', ip=router_ip, loop_id=item.interface) }}" method="POST" class="inline-form">
                                        <input type="hidden" name="action" value="enable" />
                                        <button type="submit" class="btn-chip success">Enable</button>
                                    </form>
                                    <form action="{{ url_for('update_loopback_state', ip=router_ip, loop_id=item.interface) }}" method="POST" class="inline-form">
                                        <input type="hidden" name="action" value="disable" />
                                        <button type="submit" class="btn-chip warning">Disable</button>
                                    </form>
                                    <form action="{{ url_for('delete_loopback_route', ip=router_ip, loop_id=item.interface) }}" method="POST" class="inline-form">
                                        <button type="submit" class="btn-chip danger">Delete</button>
                                    </form>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}
                <p class="empty">ยังไม่มี Loopback ในระบบ</p>
                {% endif %}
            </div>

            <div class="card-block">
                <h2>Route Table</h2>
                {% if routing %}
                    <p class="hint">อัปเดตล่าสุด: {{ routing[0].timestamp }}</p>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Protocol</th>
                                <th>Network</th>
                                <th>Distance</th>
                                <th>Next Hop</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for info in routing[0].route %}
                            <tr>
                                <td>{{ info.protocol }}</td>
                                <td>{{ info.network }}/{{ info.prefix_length }}</td>
                                <td>{{ info.distance }}</td>
                                <td>{{ info.nexthop_ip }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                {% else %}
                    <p class="empty">ยังไม่มีข้อมูลเส้นทาง</p>
                {% endif %}
            </div>

            <div class="card-block">
                <h2>Interface Status</h2>
                {% if interface_data %}
                    <p class="hint">อัปเดตล่าสุด: {{ interface_data[0].timestamp }}</p>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Interface</th>
                                <th>IP Address</th>
                                <th>Status</th>
                                <th>Protocol</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for intf in interface_data[0].interfaces %}
                            <tr>
                                <td>{{ intf.interface }}</td>
                                <td>{{ intf.ip_address }}</td>
                                <td>{{ intf.status }}</td>
                                <td>{{ intf.proto }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                {% else %}
                    <p class="empty">ยังไม่มีข้อมูลสถานะอินเทอร์เฟซ</p>
                {% endif %}
            </div>
        </div>
    </section>

</body>
</html>
